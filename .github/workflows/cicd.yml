name: Track CICD

on:
  push:
    branches:
      - main
      - feat-*

jobs:
  prepare:
    name: 准备环境与缓存
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node 与 pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: 设置 Node LTS
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # 注意：prepare 阶段不执行 pnpm install，避免产生空缓存目录

      # Java 缓存与安装移动到 test_server 阶段，避免空路径缓存错误

      - name: 写入 SSH 私钥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          touch ~/.ssh/known_hosts
          ssh-keyscan -p "${{ secrets.SERVER_PORT }}" "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null

      - name: 服务器安装 Docker/Compose（幂等，准备阶段执行）
        run: |
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}" << 'EOF'
          set -e
          if ! command -v docker >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y ca-certificates curl gnupg lsb-release
            sudo install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
            sudo apt-get update -y
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            sudo usermod -aG docker $USER || true
          fi
          EOF

  test_dashboard:
    name: 前端测试（dashboard）
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      - name: 安装依赖并测试 dashboard（pnpm）
        working-directory: packages/dashboard
        run: |
          pnpm install --frozen-lockfile=false
          if [ -f package.json ] && jq -e '.scripts.test' package.json >/dev/null 2>&1; then
            pnpm test --if-present || pnpm -s -w echo "无测试脚本，跳过"
          else
            echo "无测试脚本，跳过"
          fi

  test_server:
    name: 后端测试（server）
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      - name: 运行 Maven 测试
        working-directory: packages/server
        run: |
          chmod +x mvnw || true
          ./mvnw -q -DskipITs test

  build_dashboard:
    name: 构建前端产物
    runs-on: ubuntu-latest
    needs: [test_dashboard, test_server]
    outputs:
      artifact-name: dashboard-dist
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      - name: 构建 dashboard（pnpm）
        working-directory: packages/dashboard
        run: |
          pnpm install --frozen-lockfile=false
          pnpm build
      - name: 打包前端产物
        run: |
          mkdir -p artifacts
          tar -czf artifacts/dashboard-dist.tar.gz -C packages/dashboard dist
      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-dist
          path: artifacts/dashboard-dist.tar.gz
          if-no-files-found: error

  provision_and_deploy:
    name: 配置服务器并部署
    runs-on: ubuntu-latest
    needs: build_dashboard
    steps:
      - uses: actions/checkout@v4

      - name: 下载前端产物
        uses: actions/download-artifact@v4
        with:
          name: dashboard-dist
          path: artifacts

      - name: 准备 SSH（再次确保）
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          touch ~/.ssh/known_hosts
          ssh-keyscan -p "${{ secrets.SERVER_PORT }}" "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null

      - name: 初始化部署目录（按需创建）
        run: |
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}" << 'EOF'
          set -e
          sudo mkdir -p /opt/track/{deploy,static,logs}
          sudo mkdir -p /opt/track/deploy/nginx/conf.d
          sudo mkdir -p /opt/track/deploy/certbot/www
          EOF

      - name: 上传部署文件与前端产物
        run: |
          rsync -az -e "ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} -i ~/.ssh/id_rsa" \
            deploy/ "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}":/opt/track/deploy/
          scp -o StrictHostKeyChecking=no -P "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa \
            artifacts/dashboard-dist.tar.gz "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}":/opt/track/

      - name: 构建与启动（首次 HTTP 服务）
        run: |
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}" << 'EOF'
          set -e
          cd /opt/track
          # 解压前端静态资源至 deploy/static
          mkdir -p /opt/track/deploy/static
          tar -xzf dashboard-dist.tar.gz -C /opt/track/deploy/static --strip-components=1 || true
          # 使用 docker compose 启动（仅 HTTP）
          docker compose -f /opt/track/deploy/docker-compose.yml up -d --build
          EOF

      - name: 申请/续期证书（certbot，webroot 模式）
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}" << EOF
          set -e
          sudo apt-get update -y
          sudo apt-get install -y certbot
          sudo certbot certonly --webroot -w /opt/track/deploy/certbot/www -d "$DOMAIN" --non-interactive --agree-tos --register-unsafely-without-email || true
          EOF

      - name: 启用 HTTPS 配置并重启 Nginx
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}" << EOF
          set -e
          if [ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]; then
            sudo sed "s/__DOMAIN__/$DOMAIN/g" /opt/track/deploy/nginx/conf.d/app-ssl.conf.template | sudo tee /opt/track/deploy/nginx/conf.d/app-ssl.conf >/dev/null
            docker compose -f /opt/track/deploy/docker-compose.yml restart nginx
          else
            echo "未找到证书，保留 HTTP 服务，稍后可重试 certbot" >&2
          fi
          EOF

  post_check:
    name: 部署后健康检查
    runs-on: ubuntu-latest
    needs: provision_and_deploy
    steps:
      - name: 访问站点主页
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          set -e
          curl -sS http://$DOMAIN -I || true
          curl -sS https://$DOMAIN -I || true
      - name: 访问 API 健康（若存在）
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          curl -sS http://$DOMAIN/api/health || true
      - name: 输出容器状态
        run: |
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}" << 'EOF'
          set -e
          docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}'
          echo '--- nginx logs (last 100 lines) ---'
          docker logs --tail=100 track-nginx || true
          echo '--- api logs (last 100 lines) ---'
          docker logs --tail=100 track-api || true
          EOF


