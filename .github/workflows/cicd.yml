name: Track CICD

env:
  NODE_VERSION: '20.19.0'
  PNPM_VERSION: '9'

on:
  push:
    branches:
      - main
      - feat-*

jobs:
  prepare:
    name: 准备环境与缓存
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node 与 pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: 设置 Node LTS
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # 注意：prepare 阶段不执行 pnpm install，避免产生空缓存目录

      # Java 缓存与安装移动到 test_server 阶段，避免空路径缓存错误

      - name: 写入 SSH 私钥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          touch ~/.ssh/known_hosts
          ssh-keyscan -p "${{ secrets.SERVER_PORT }}" "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null

      - name: 服务器安装 Docker/Compose（幂等，准备阶段执行）
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -p "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}" << 'EOF'
          set -e
          if ! command -v docker >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y ca-certificates curl gnupg lsb-release
            sudo install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
            sudo apt-get update -y
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            sudo usermod -aG docker $USER || true
          fi
          EOF

  test_dashboard:
    name: 前端测试（dashboard）
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - name: 清理 pnpm 缓存
        run: pnpm store prune || true
      - name: 安装依赖并测试 dashboard（pnpm）
        working-directory: packages/dashboard
        env:
          # 抑制 Node.js 警告，减少 webidl-conversions 等依赖的噪音
          NODE_OPTIONS: --no-warnings
        run: |
          pnpm install --frozen-lockfile=false
          # 检查测试脚本是否存在，不存在则报错中断
          if ! jq -e '.scripts.test' package.json >/dev/null 2>&1; then
            echo "❌ 错误：package.json 中未找到 test 脚本，CI 中断"
            exit 1
          fi
          # 执行测试（setup.ts 中已处理 unhandled errors）
          pnpm test

  test_server:
    name: 后端测试（server）
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      - name: 运行 Maven 测试
        working-directory: packages/server
        run: |
          chmod +x mvnw || true
          ./mvnw -q -DskipITs test

  build_dashboard:
    name: 构建 Dashboard 产物
    runs-on: ubuntu-latest
    needs: [test_dashboard, test_server]
    outputs:
      artifact-name: dashboard-dist
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - name: 清理 pnpm 缓存
        run: pnpm store prune || true
      - name: 构建 dashboard（pnpm）
        working-directory: packages/dashboard
        run: |
          pnpm install --frozen-lockfile=false
          pnpm build
      - name: 打包前端产物
        run: |
          mkdir -p artifacts
          tar -czf artifacts/dashboard-dist.tar.gz -C packages/dashboard dist
      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-dist
          path: artifacts/dashboard-dist.tar.gz
          if-no-files-found: error

  build_sdk:
    name: 构建 SDK（供示例使用）
    runs-on: ubuntu-latest
    needs: [test_dashboard, test_server]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - name: 清理 pnpm 缓存
        run: pnpm store prune || true
      - name: 安装并构建 SDK
        working-directory: packages/client-sdk
        run: |
          pnpm install --frozen-lockfile=false
          pnpm build
      - name: 上传 SDK 产物
        uses: actions/upload-artifact@v4
        with:
          name: client-sdk-dist
          path: packages/client-sdk/dist
          if-no-files-found: error

  build_example:
    name: 构建示例项目（并发）
    runs-on: ubuntu-latest
    needs: [build_sdk]
    strategy:
      fail-fast: false
      matrix:
        example:
          - id: vue3
            dir: packages/client-sdk/examples/vue3-example
            out_dir: dist
            build: |
              pnpm install --frozen-lockfile=false
              pnpm build
          - id: next
            dir: packages/client-sdk/examples/nextjs-example
            out_dir: out
            build: |
              pnpm install --frozen-lockfile=false
              pnpm build
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - name: 清理 pnpm 缓存
        run: pnpm store prune || true
      - name: 下载 SDK 产物
        uses: actions/download-artifact@v4
        with:
          name: client-sdk-dist
          path: packages/client-sdk/dist
      - name: 构建示例 ${{ matrix.example.id }}
        working-directory: ${{ matrix.example.dir }}
        run: |
          ${{ matrix.example.build }}
      - name: 上传示例产物 ${{ matrix.example.id }}
        uses: actions/upload-artifact@v4
        with:
          name: example-${{ matrix.example.id }}
          path: ${{ matrix.example.dir }}/${{ matrix.example.out_dir }}
          if-no-files-found: error

  assemble_examples:
    name: 汇总示例产物
    runs-on: ubuntu-latest
    needs: [build_example]
    steps:
      - uses: actions/checkout@v4
      - name: 下载示例（vue3）
        uses: actions/download-artifact@v4
        with:
          name: example-vue3
          path: artifacts/examples/vue3
      - name: 下载示例（next）
        uses: actions/download-artifact@v4
        with:
          name: example-next
          path: artifacts/examples/next
      - name: 下载 SDK 产物
        uses: actions/download-artifact@v4
        with:
          name: client-sdk-dist
          path: artifacts/examples/dist
      - name: 拷贝 vanilla 示例
        run: |
          mkdir -p artifacts/examples/vanilla
          cp -r packages/client-sdk/examples/vanilla-example/* artifacts/examples/vanilla/
      - name: 打包示例产物
        run: |
          tar -czf artifacts/examples-dist.tar.gz -C artifacts examples
      - name: 上传示例产物（汇总）
        uses: actions/upload-artifact@v4
        with:
          name: examples-dist
          path: artifacts/examples-dist.tar.gz
          if-no-files-found: error

  provision_and_deploy:
    name: 配置服务器并部署
    runs-on: ubuntu-latest
    needs: [build_dashboard, assemble_examples]
    steps:
      - uses: actions/checkout@v4

      - name: 下载前端产物
        uses: actions/download-artifact@v4
        with:
          name: dashboard-dist
          path: artifacts

      - name: 下载示例产物
        uses: actions/download-artifact@v4
        with:
          name: examples-dist
          path: artifacts

      - name: 准备 SSH（再次确保）
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          touch ~/.ssh/known_hosts
          ssh-keyscan -p "${{ secrets.SERVER_PORT }}" "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null
          # 配置 SSH 保活参数，防止长时间构建时连接断开
          cat >> ~/.ssh/config << 'SSHCONFIG'
          Host *
            ServerAliveInterval 60
            ServerAliveCountMax 10
            TCPKeepAlive yes
          SSHCONFIG
          chmod 600 ~/.ssh/config

      - name: 初始化部署目录（按需创建）
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -p "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}" << 'EOF'
          set -e
          sudo mkdir -p /opt/track/{deploy,static,logs,packages}
          sudo mkdir -p /opt/track/deploy/nginx/conf.d
          sudo mkdir -p /opt/track/deploy/certbot/www
          EOF

      - name: 上传部署文件与前端产物
        run: |
          rsync -az -e "ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -p ${{ secrets.SERVER_PORT }} -i ~/.ssh/id_rsa" \
            deploy/ "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}":/opt/track/deploy/
          # 同步后端源码，供 docker compose 在 /opt/track/deploy 相对路径 ../packages/server 构建
          rsync -az -e "ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -p ${{ secrets.SERVER_PORT }} -i ~/.ssh/id_rsa" \
            packages/server/ "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}":/opt/track/packages/server/
          scp -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -P "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa \
            artifacts/dashboard-dist.tar.gz "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}":/opt/track/
          scp -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -P "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa \
            artifacts/examples-dist.tar.gz "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}":/opt/track/

      - name: 构建与启动（首次 HTTP 服务）
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -p "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}" << 'EOF'
          set -e
          cd /opt/track
          # 解压前端静态资源至 deploy/static
          mkdir -p /opt/track/deploy/static
          tar -xzf dashboard-dist.tar.gz -C /opt/track/deploy/static --strip-components=1 || true
          # 清理临时压缩包
          rm -f dashboard-dist.tar.gz
          # 解压示例到 /opt/track/deploy/static/examples
          mkdir -p /opt/track/deploy/static/examples
          tar -xzf examples-dist.tar.gz -C /opt/track/deploy/static --strip-components=1 || true
          rm -f examples-dist.tar.gz
          # 使用 docker compose 启动（仅 HTTP，添加超时和保活）
          # 设置 DOCKER_BUILDKIT=1 可提高构建稳定性，COMPOSE_HTTP_TIMEOUT 延长超时时间
          DOCKER_BUILDKIT=1 COMPOSE_HTTP_TIMEOUT=600 docker compose -f /opt/track/deploy/docker-compose.yml up -d --build
          # 清理未使用的 Docker 镜像和构建缓存（保留正在使用的）
          docker system prune -f --volumes=false || true
          EOF

      - name: 申请/续期证书（certbot，webroot 模式）
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -p "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}" << EOF
          set -e
          sudo apt-get update -y
          sudo apt-get install -y certbot
          sudo certbot certonly --webroot -w /opt/track/deploy/certbot/www -d "$DOMAIN" --non-interactive --agree-tos --register-unsafely-without-email || true
          EOF

      - name: 启用 HTTPS 配置并重启 Nginx
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -p "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}" << EOF
          set -e
          if [ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]; then
            sudo sed "s/__DOMAIN__/$DOMAIN/g" /opt/track/deploy/nginx/conf.d/app-ssl.conf.template | sudo tee /opt/track/deploy/nginx/conf.d/app-ssl.conf >/dev/null
            docker compose -f /opt/track/deploy/docker-compose.yml restart nginx
          else
            echo "未找到证书，保留 HTTP 服务，稍后可重试 certbot" >&2
          fi
          EOF

  post_check:
    name: 部署后健康检查
    runs-on: ubuntu-latest
    needs: provision_and_deploy
    steps:
      - name: 准备 SSH（与前一致）
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          touch ~/.ssh/known_hosts
          ssh-keyscan -p "${{ secrets.SERVER_PORT }}" "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null
      - name: 访问站点主页
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          set -e
          curl -sS http://$DOMAIN -I || true
          curl -sS https://$DOMAIN -I || true
      - name: 访问 API 健康（若存在）
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          curl -sS http://$DOMAIN/api/health || true
      - name: 输出容器状态
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -p "${{ secrets.SERVER_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}" << 'EOF'
          set -e
          docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}'
          echo '--- nginx logs (last 100 lines) ---'
          docker logs --tail=100 track-nginx || true
          echo '--- api logs (last 100 lines) ---'
          docker logs --tail=100 track-api || true
          EOF


